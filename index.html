<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>360Â° Depth Panorama</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #06060c;
  --surface: #0e0e18;
  --surface2: #161625;
  --cyan: #00f0ff;
  --cyan-dim: rgba(0,240,255,0.15);
  --magenta: #ff2d78;
  --violet: #8b5cf6;
  --lime: #a3e635;
  --text: #e4e4ef;
  --text2: #6c6c88;
  --border: rgba(255,255,255,0.06);
  --glass: rgba(14,14,24,0.88);
  --r: 14px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:'Syne',sans-serif;
  background:var(--bg);
  color:var(--text);
  overflow-x:hidden;
  min-height:100vh;
  -webkit-user-select:none;
  user-select:none;
}

/* SCREENS */
.screen { display:none; width:100%; min-height:100vh; position:relative; }
.screen.active { display:flex; flex-direction:column; }

/* ========== HOME ========== */
#homeScreen {
  align-items:center; justify-content:center;
  padding:40px 20px; text-align:center;
  background:
    radial-gradient(ellipse at 30% 20%, rgba(0,240,255,0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 70% 80%, rgba(139,92,246,0.05) 0%, transparent 50%),
    var(--bg);
}
.logo-mark {
  width:88px; height:88px; margin-bottom:28px; position:relative;
  animation: fadeIn .8s ease;
}
.logo-mark svg { width:100%; height:100%; }
.logo-orbit {
  position:absolute; inset:-16px;
  border:1px dashed rgba(0,240,255,0.2); border-radius:50%;
  animation: spin 25s linear infinite;
}
.logo-orbit2 {
  position:absolute; inset:-8px;
  border:1px solid rgba(139,92,246,0.15); border-radius:50%;
  animation: spin 18s linear infinite reverse;
}
@keyframes spin { to { transform:rotate(360deg); } }
@keyframes fadeIn { from{opacity:0;transform:translateY(-16px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

.tag {
  display:inline-flex; align-items:center; gap:5px;
  padding:5px 12px; background:var(--cyan-dim);
  border:1px solid rgba(0,240,255,0.2); border-radius:100px;
  font-family:'JetBrains Mono',monospace; font-size:10px;
  color:var(--cyan); letter-spacing:1.5px; text-transform:uppercase;
  margin-bottom:20px; animation: fadeIn .6s ease;
}
h1 {
  font-size:34px; font-weight:800; line-height:1.15;
  margin-bottom:14px; animation: fadeIn 1s ease;
  background:linear-gradient(135deg,#fff 20%,var(--cyan) 80%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.hero-sub {
  font-size:14px; color:var(--text2); line-height:1.7;
  max-width:340px; margin-bottom:36px; animation: fadeIn 1.2s ease;
}

/* Feature cards */
.features {
  display:grid; grid-template-columns:1fr 1fr;
  gap:10px; width:100%; max-width:380px;
  margin-bottom:36px; animation: fadeUp 1s ease .2s both;
}
.feat {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:18px 14px; text-align:left;
}
.feat-icon {
  width:32px; height:32px; border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  margin-bottom:10px; font-size:16px;
}
.feat-icon.c1 { background:rgba(0,240,255,0.12); }
.feat-icon.c2 { background:rgba(139,92,246,0.12); }
.feat-icon.c3 { background:rgba(255,45,120,0.12); }
.feat-icon.c4 { background:rgba(163,230,53,0.12); }
.feat-title { font-size:13px; font-weight:700; margin-bottom:4px; }
.feat-desc { font-size:11px; color:var(--text2); line-height:1.4; }

.btn-start {
  display:inline-flex; align-items:center; gap:10px;
  padding:16px 40px; background:linear-gradient(135deg,var(--cyan),#00bcd4);
  color:var(--bg); font-family:'Syne',sans-serif;
  font-size:16px; font-weight:700; border:none; border-radius:100px;
  cursor:pointer; box-shadow:0 4px 28px rgba(0,240,255,0.25);
  animation: fadeUp 1.2s ease .4s both;
  transition: transform .2s, box-shadow .2s;
}
.btn-start:active { transform:scale(.96); }

/* ========== CAPTURE ========== */
#captureScreen { height:100vh; overflow:hidden; background:#000; }
.cam-wrap { position:relative; width:100%; height:100%; }
#camVideo { width:100%; height:100%; object-fit:cover; }
#capCanvas { display:none; }

.flash { position:absolute; inset:0; background:#fff; opacity:0; z-index:30; pointer-events:none; transition:opacity .05s; }
.flash.on { opacity:.5; transition:none; }

/* HUD Top */
.hud-top {
  position:absolute; top:0; left:0; right:0; z-index:20;
  padding:48px 16px 16px;
  background:linear-gradient(to bottom,rgba(0,0,0,.7),transparent);
}
.hud-row { display:flex; justify-content:space-between; align-items:center; }
.hud-stat {
  font-family:'JetBrains Mono',monospace; font-size:11px; color:rgba(255,255,255,.6);
}
.hud-stat b { color:var(--cyan); font-size:13px; }
.btn-x {
  width:34px; height:34px; border-radius:50%;
  background:rgba(255,255,255,.12); border:none; color:#fff;
  font-size:16px; cursor:pointer; display:flex;
  align-items:center; justify-content:center; backdrop-filter:blur(8px);
}

/* Thumbnails */
.thumbs {
  position:absolute; top:96px; left:0; right:0; z-index:15;
  display:flex; gap:5px; padding:0 12px;
  overflow-x:auto; scrollbar-width:none;
}
.thumbs::-webkit-scrollbar{display:none}
.th {
  width:40px; height:40px; border-radius:7px; overflow:hidden;
  flex-shrink:0; border:2px solid rgba(255,255,255,.25);
  animation: pop .25s ease;
}
.th img { width:100%; height:100%; object-fit:cover; }
@keyframes pop { from{transform:scale(0);opacity:0} to{transform:scale(1);opacity:1} }

/* Angle + Progress */
.angle-box {
  position:absolute; bottom:168px; left:50%; transform:translateX(-50%); z-index:15;
  text-align:center;
}
.angle-num {
  font-family:'JetBrains Mono',monospace; font-size:36px; font-weight:700;
  color:#fff; text-shadow:0 0 24px rgba(0,240,255,.3);
}
.angle-lbl { font-size:10px; color:var(--text2); text-transform:uppercase; letter-spacing:2px; margin-top:2px; }

.prog-wrap {
  position:absolute; bottom:136px; left:16px; right:16px; z-index:15;
}
.prog-track { width:100%; height:3px; background:rgba(255,255,255,.08); border-radius:2px; }
.prog-fill {
  height:100%; border-radius:2px; width:0%;
  background:linear-gradient(90deg,var(--cyan),var(--violet));
  transition:width .3s ease;
}
.prog-labels {
  display:flex; justify-content:space-between; margin-top:4px;
  font-family:'JetBrains Mono',monospace; font-size:9px; color:var(--text2);
}

/* Distance indicator overlay */
.depth-indicator {
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:14;
  pointer-events:none; text-align:center;
}
.depth-rings {
  width:180px; height:180px; position:relative;
}
.d-ring {
  position:absolute; border-radius:50%; border:1px solid rgba(0,240,255,.15);
  display:flex; align-items:flex-start; justify-content:center; padding-top:4px;
}
.d-ring span {
  font-family:'JetBrains Mono',monospace; font-size:8px; color:rgba(0,240,255,.4);
  background:rgba(0,0,0,.6); padding:1px 4px; border-radius:3px;
}
.d-ring.r1 { inset:0; border-color:rgba(163,230,53,.2); }
.d-ring.r2 { inset:20px; border-color:rgba(0,240,255,.2); }
.d-ring.r3 { inset:45px; border-color:rgba(139,92,246,.2); }
.d-ring.r4 { inset:65px; }
.crosshair {
  position:absolute; top:50%; left:50%; width:20px; height:20px;
  margin:-10px 0 0 -10px;
}
.crosshair::before,.crosshair::after {
  content:''; position:absolute; background:var(--cyan);
}
.crosshair::before { width:1px; height:100%; left:50%; }
.crosshair::after { height:1px; width:100%; top:50%; }

/* Bottom controls */
.cam-btns {
  position:absolute; bottom:0; left:0; right:0; z-index:20;
  padding:16px 20px 36px;
  background:linear-gradient(to top,rgba(0,0,0,.75),transparent);
  display:flex; align-items:center; justify-content:center; gap:28px;
  pointer-events:auto;
}
.btn-mode {
  padding:8px 16px; border-radius:100px;
  background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
  color:#fff; font-family:'Syne',sans-serif; font-size:12px; font-weight:600;
  cursor:pointer; backdrop-filter:blur(8px); transition:.2s;
}
.btn-mode.on { background:rgba(0,240,255,.15); border-color:var(--cyan); color:var(--cyan); }
.btn-shutter {
  width:68px; height:68px; border-radius:50%; background:transparent;
  border:3px solid #fff; cursor:pointer; position:relative; transition:.2s;
}
.btn-shutter::after {
  content:''; position:absolute; inset:4px; border-radius:50%;
  background:#fff; transition:.15s;
}
.btn-shutter:active::after { inset:6px; background:var(--cyan); }
.btn-shutter.auto-on { border-color:var(--cyan); animation: pulse 1.4s ease infinite; }
.btn-shutter.auto-on::after { background:var(--cyan); }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(0,240,255,.3)} 50%{box-shadow:0 0 0 12px transparent} }

.btn-finish {
  padding:8px 16px; border-radius:100px;
  background:linear-gradient(135deg,var(--magenta),#ff6b9d);
  border:none; color:#fff; font-family:'Syne',sans-serif;
  font-size:12px; font-weight:600; cursor:pointer;
}

/* ========== PROCESSING ========== */
#processScreen {
  align-items:center; justify-content:center; height:100vh;
  padding:40px 20px; text-align:center; background:var(--bg);
}
.proc-visual { width:160px; height:160px; position:relative; margin-bottom:28px; }
.proc-ring {
  position:absolute; inset:0; border:2px solid transparent;
  border-radius:50%; animation: spin 1.2s linear infinite;
}
.proc-ring:nth-child(1) { border-top-color:var(--cyan); }
.proc-ring:nth-child(2) { inset:14px; border-top-color:var(--violet); animation-duration:1.8s; animation-direction:reverse; }
.proc-ring:nth-child(3) { inset:28px; border-top-color:var(--magenta); animation-duration:2.4s; }
.proc-ring:nth-child(4) { inset:42px; border-top-color:var(--lime); animation-duration:3s; animation-direction:reverse; }

.proc-pct {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-family:'JetBrains Mono',monospace; font-size:24px; font-weight:700; color:var(--cyan);
}
.proc-title { font-size:20px; font-weight:700; margin-bottom:6px; }
.proc-step { font-size:13px; color:var(--text2); }

/* Depth analysis card during processing */
.depth-analysis {
  margin-top:28px; background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:18px; width:100%; max-width:340px; text-align:left;
}
.da-title {
  font-family:'JetBrains Mono',monospace; font-size:10px;
  color:var(--cyan); text-transform:uppercase; letter-spacing:1.5px;
  margin-bottom:12px;
}
.da-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:6px 0; border-bottom:1px solid var(--border);
}
.da-row:last-child { border:none; }
.da-label { font-size:12px; color:var(--text2); }
.da-val { font-family:'JetBrains Mono',monospace; font-size:12px; font-weight:700; }
.da-val.good { color:var(--lime); }
.da-val.ok { color:var(--cyan); }
.da-val.warn { color:#fbbf24; }

/* ========== 3D VIEWER ========== */
#viewerScreen { height:100vh; background:#000; }
#viewer3D { width:100%; height:100%; }

.v-hud {
  position:absolute; top:0; left:0; right:0; z-index:10;
  padding:48px 16px 14px;
  background:linear-gradient(to bottom,rgba(0,0,0,.6),transparent);
  display:flex; justify-content:space-between; align-items:flex-start;
}
.v-title { font-size:15px; font-weight:700; }
.v-sub { font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--text2); margin-top:3px; }

.v-bottom {
  position:absolute; bottom:0; left:0; right:0; z-index:10;
  padding:16px 16px 36px;
  background:linear-gradient(to top,rgba(0,0,0,.8),transparent);
}

/* Depth layer toggles */
.layer-toggles {
  display:flex; gap:8px; margin-bottom:14px; overflow-x:auto;
  scrollbar-width:none; padding-bottom:4px;
}
.layer-toggles::-webkit-scrollbar{display:none}
.layer-btn {
  flex-shrink:0; padding:6px 14px; border-radius:100px;
  font-family:'JetBrains Mono',monospace; font-size:10px;
  border:1px solid var(--border); background:var(--glass);
  color:var(--text2); cursor:pointer; backdrop-filter:blur(8px);
  transition:.2s; white-space:nowrap;
}
.layer-btn.on { border-color:var(--cyan); color:var(--cyan); background:rgba(0,240,255,.08); }
.layer-btn .dot {
  display:inline-block; width:6px; height:6px; border-radius:50%;
  margin-right:5px; vertical-align:middle;
}

/* Angle bar */
.v-angle-bar { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
.v-track { flex:1; height:3px; background:rgba(255,255,255,.1); border-radius:2px; position:relative; }
.v-thumb {
  position:absolute; top:-5px; width:11px; height:11px;
  background:var(--cyan); border-radius:50%;
  box-shadow:0 0 10px rgba(0,240,255,.4); transition:left .05s;
}
.v-angle-val {
  font-family:'JetBrains Mono',monospace; font-size:11px;
  color:var(--cyan); min-width:36px; text-align:right;
}

/* Depth info card */
.depth-info {
  background:var(--glass); border:1px solid var(--border);
  border-radius:10px; padding:10px 14px; margin-bottom:12px;
  backdrop-filter:blur(8px);
  display:flex; justify-content:space-around;
}
.di-item { text-align:center; }
.di-val {
  font-family:'JetBrains Mono',monospace; font-size:16px; font-weight:700;
}
.di-val.c { color:var(--cyan); }
.di-val.m { color:var(--magenta); }
.di-val.l { color:var(--lime); }
.di-label { font-size:9px; color:var(--text2); margin-top:2px; text-transform:uppercase; letter-spacing:1px; }

.v-btns { display:flex; gap:10px; }
.v-btn {
  flex:1; padding:12px; border-radius:10px;
  border:1px solid var(--border); background:var(--glass);
  color:var(--text); font-family:'Syne',sans-serif;
  font-size:13px; font-weight:600; cursor:pointer;
  backdrop-filter:blur(8px); text-align:center; transition:.2s;
}
.v-btn:active { transform:scale(.97); }
.v-btn.pri { background:linear-gradient(135deg,var(--cyan),#00bcd4); color:var(--bg); border:none; }

/* Depth map toggle overlay */
.depth-map-overlay {
  position:absolute; top:96px; right:12px; z-index:15;
  width:120px; height:90px; border-radius:10px;
  border:1px solid var(--border); overflow:hidden;
  background:#000; display:none;
}
.depth-map-overlay.show { display:block; }
.depth-map-overlay canvas { width:100%; height:100%; }
.dm-label {
  position:absolute; bottom:0; left:0; right:0;
  background:rgba(0,0,0,.7); padding:3px 6px;
  font-family:'JetBrains Mono',monospace; font-size:8px;
  color:var(--cyan); text-align:center;
}

/* Toast */
.toast {
  position:fixed; top:56px; left:50%; z-index:200;
  transform:translateX(-50%) translateY(-80px);
  padding:10px 18px; background:var(--glass);
  border:1px solid var(--border); border-radius:100px;
  font-size:12px; backdrop-filter:blur(8px);
  transition:transform .3s ease; white-space:nowrap;
}
.toast.on { transform:translateX(-50%) translateY(0); }

/* Guide */
.guide-bg {
  position:fixed; inset:0; background:rgba(0,0,0,.85);
  z-index:100; display:none; align-items:center;
  justify-content:center; padding:20px; backdrop-filter:blur(6px);
}
.guide-bg.on { display:flex; }
.guide-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:20px; padding:28px 20px; max-width:340px; text-align:center;
}
.guide-card h2 { font-size:18px; font-weight:700; margin-bottom:10px; }
.guide-card p { font-size:13px; color:var(--text2); line-height:1.6; margin-bottom:20px; }
.guide-card .guide-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:20px;
}
.guide-card .gg {
  background:var(--surface2); border-radius:10px; padding:12px 8px;
}
.gg-icon { font-size:20px; margin-bottom:6px; }
.gg-text { font-size:11px; color:var(--text2); line-height:1.3; }
.btn-guide {
  padding:12px 28px; border-radius:100px;
  background:linear-gradient(135deg,var(--cyan),#00bcd4);
  color:var(--bg); border:none; font-family:'Syne',sans-serif;
  font-size:14px; font-weight:700; cursor:pointer; width:100%;
}

/* Desktop */
@media(min-width:768px) {
  .desk-note {
    position:fixed; inset:0; background:var(--bg); z-index:1000;
    display:flex; align-items:center; justify-content:center; text-align:center; padding:40px;
  }
  .desk-note.off { display:none; }
  .desk-note h2 { font-size:22px; margin-bottom:10px; }
  .desk-note p { color:var(--text2); margin-bottom:20px; line-height:1.6; }
  .desk-note button {
    padding:10px 20px; border-radius:100px;
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
    color:#fff; font-family:'Syne',sans-serif; cursor:pointer;
  }
}
</style>
</head>
<body>

<div class="desk-note" id="deskNote">
  <div>
    <h2>ğŸ“± ëª¨ë°”ì¼ ìµœì í™” ì•±</h2>
    <p>ì¹´ë©”ë¼ì™€ ìì´ë¡œìŠ¤ì½”í”„ ê¸°ë°˜ ì•±ì…ë‹ˆë‹¤.<br>ìŠ¤ë§ˆíŠ¸í°ì—ì„œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
    <button onclick="document.getElementById('deskNote').classList.add('off')">ë°ìŠ¤í¬í†± ë¯¸ë¦¬ë³´ê¸°</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="guide-bg" id="guide">
  <div class="guide-card">
    <h2>ğŸ¯ ì´¬ì˜ + ê¹Šì´ ë¶„ì„ ê°€ì´ë“œ</h2>
    <p>í•œ ìë¦¬ì—ì„œ ì²œì²œíˆ 360Â° íšŒì „í•˜ë©° ì´¬ì˜í•©ë‹ˆë‹¤.<br>AIê°€ ê° ì‚¬ì§„ì˜ ê¹Šì´ë¥¼ ë¶„ì„í•˜ì—¬<br>3D íŒŒë…¸ë¼ë§ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
    <div class="guide-grid">
      <div class="gg"><div class="gg-icon">ğŸ“</div><div class="gg-text">5~50m<br>ìµœì  ê±°ë¦¬</div></div>
      <div class="gg"><div class="gg-icon">ğŸ”„</div><div class="gg-text">ì²œì²œíˆ<br>ê· ì¼í•˜ê²Œ íšŒì „</div></div>
      <div class="gg"><div class="gg-icon">ğŸ¤–</div><div class="gg-text">ìë™ ëª¨ë“œ:<br>30Â° ê°„ê²© ì´¬ì˜</div></div>
      <div class="gg"><div class="gg-icon">ğŸ”ï¸</div><div class="gg-text">3D ê¹Šì´<br>ë ˆì´ì–´ ë¶„ë¦¬</div></div>
    </div>
    <button class="btn-guide" onclick="document.getElementById('guide').classList.remove('on')">ì´¬ì˜ ì‹œì‘</button>
  </div>
</div>

<!-- HOME -->
<div class="screen active" id="homeScreen">
  <div class="tag">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20M2 12h20"/></svg>
    DEPTH PANORAMA v2.0
  </div>
  <div class="logo-mark">
    <div class="logo-orbit"></div>
    <div class="logo-orbit2"></div>
    <svg viewBox="0 0 88 88" fill="none">
      <defs>
        <linearGradient id="g1" x1="0" y1="0" x2="88" y2="88">
          <stop offset="0%" stop-color="#00f0ff"/>
          <stop offset="50%" stop-color="#8b5cf6"/>
          <stop offset="100%" stop-color="#ff2d78"/>
        </linearGradient>
      </defs>
      <circle cx="44" cy="44" r="36" stroke="url(#g1)" stroke-width="1.5" fill="none"/>
      <circle cx="44" cy="44" r="24" stroke="url(#g1)" stroke-width="1.5" fill="none" opacity=".5"/>
      <circle cx="44" cy="44" r="12" stroke="url(#g1)" stroke-width="1.5" fill="none" opacity=".3"/>
      <!-- Depth layers icon -->
      <ellipse cx="44" cy="38" rx="18" ry="6" stroke="rgba(163,230,53,.5)" stroke-width="1" fill="none"/>
      <ellipse cx="44" cy="44" rx="22" ry="8" stroke="rgba(0,240,255,.5)" stroke-width="1" fill="none"/>
      <ellipse cx="44" cy="50" rx="26" ry="10" stroke="rgba(139,92,246,.5)" stroke-width="1" fill="none"/>
      <circle cx="44" cy="44" r="3" fill="#00f0ff"/>
    </svg>
  </div>
  <h1>360Â° Depth<br>Panorama</h1>
  <p class="hero-sub">AI ê¹Šì´ ì¶”ì •ìœ¼ë¡œ ì‚¬ì§„ì„ 3D ë ˆì´ì–´ë¡œ ë¶„ë¦¬í•˜ê³ <br>ëª°ì…ê° ìˆëŠ” 360Â° íŒŒë…¸ë¼ë§ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p>

  <div class="features">
    <div class="feat">
      <div class="feat-icon c1">ğŸ“·</div>
      <div class="feat-title">ìŠ¤ë§ˆíŠ¸ ìº¡ì²˜</div>
      <div class="feat-desc">ìì´ë¡œìŠ¤ì½”í”„ ê¸°ë°˜ ìë™/ìˆ˜ë™ ì´¬ì˜</div>
    </div>
    <div class="feat">
      <div class="feat-icon c2">ğŸ§ </div>
      <div class="feat-title">AI ê¹Šì´ ë¶„ì„</div>
      <div class="feat-desc">MiDaS ê¸°ë°˜ ê¹Šì´ ë§µ ì¶”ì¶œ</div>
    </div>
    <div class="feat">
      <div class="feat-icon c3">ğŸŒ</div>
      <div class="feat-title">3D ë·°ì–´</div>
      <div class="feat-desc">Three.js êµ¬ì²´ ë§¤í•‘ ë Œë”ë§</div>
    </div>
    <div class="feat">
      <div class="feat-icon c4">ğŸ“</div>
      <div class="feat-title">ê±°ë¦¬ ìµœì í™”</div>
      <div class="feat-desc">5~50m ê³¨ë“ ì¡´ ê°€ì´ë“œ</div>
    </div>
  </div>

  <button class="btn-start" onclick="beginCapture()">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
    ì´¬ì˜ ì‹œì‘í•˜ê¸°
  </button>
</div>

<!-- CAPTURE -->
<div class="screen" id="captureScreen">
  <div class="cam-wrap">
    <video id="camVideo" autoplay playsinline muted></video>
    <canvas id="capCanvas"></canvas>
    <div class="flash" id="flash"></div>

    <div class="hud-top">
      <div class="hud-row">
        <div class="hud-stat">ì´¬ì˜ <b id="pCount">0</b> / 12ì¥</div>
        <div class="hud-stat">ê¹Šì´ë¶„ì„ <b id="depthStatus">ëŒ€ê¸°</b></div>
        <button class="btn-x" onclick="cancelCapture()">âœ•</button>
      </div>
    </div>

    <div class="thumbs" id="thumbs"></div>

    <div class="depth-indicator" id="depthIndicator">
      <div class="depth-rings">
        <div class="d-ring r1"><span>50m+</span></div>
        <div class="d-ring r2"><span>20m</span></div>
        <div class="d-ring r3"><span>5m</span></div>
        <div class="d-ring r4"><span>2m</span></div>
        <div class="crosshair"></div>
      </div>
    </div>

    <div class="angle-box">
      <div class="angle-num" id="angleNum">0Â°</div>
      <div class="angle-lbl">current heading</div>
    </div>

    <div class="prog-wrap">
      <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
      <div class="prog-labels"><span>0Â°</span><span>360Â°</span></div>
    </div>

    <div class="cam-btns">
      <button class="btn-mode" id="btnAutoMode" onclick="toggleAuto()">ìë™</button>
      <button class="btn-shutter" id="btnShutter" onclick="takePhoto()"></button>
      <button class="btn-finish" onclick="finishCapture()">ì™„ë£Œ</button>
    </div>
  </div>
</div>

<!-- PROCESSING -->
<div class="screen" id="processScreen">
  <div class="proc-visual">
    <div class="proc-ring"></div>
    <div class="proc-ring"></div>
    <div class="proc-ring"></div>
    <div class="proc-ring"></div>
    <div class="proc-pct" id="procPct">0%</div>
  </div>
  <div class="proc-title" id="procTitle">ê¹Šì´ ë¶„ì„ ì¤‘...</div>
  <div class="proc-step" id="procStep">ì´ë¯¸ì§€ ì „ì²˜ë¦¬</div>

  <div class="depth-analysis" id="depthAnalysis" style="opacity:0;transition:opacity .5s">
    <div class="da-title">ğŸ“Š Depth Analysis Report</div>
    <div class="da-row"><span class="da-label">ê°ì§€ ë ˆì´ì–´</span><span class="da-val ok" id="daLayers">â€”</span></div>
    <div class="da-row"><span class="da-label">ìµœì  ê±°ë¦¬ ë²”ìœ„</span><span class="da-val good" id="daRange">â€”</span></div>
    <div class="da-row"><span class="da-label">3D íš¨ê³¼ í’ˆì§ˆ</span><span class="da-val" id="daQuality">â€”</span></div>
    <div class="da-row"><span class="da-label">ì¶”ì • ìµœëŒ€ ê±°ë¦¬</span><span class="da-val ok" id="daMaxDist">â€”</span></div>
    <div class="da-row"><span class="da-label">í•©ì„± í•´ìƒë„</span><span class="da-val" id="daRes">â€”</span></div>
  </div>
</div>

<!-- 3D VIEWER -->
<div class="screen" id="viewerScreen">
  <div id="viewer3D"></div>

  <div class="depth-map-overlay" id="depthMapOvl">
    <canvas id="depthMapCanvas"></canvas>
    <div class="dm-label">DEPTH MAP</div>
  </div>

  <div class="v-hud">
    <div>
      <div class="v-title">360Â° 3D Panorama</div>
      <div class="v-sub" id="vMeta">12 photos Â· 4 depth layers</div>
    </div>
    <button class="btn-x" onclick="goHome()">âœ•</button>
  </div>

  <div class="v-bottom">
    <div class="depth-info">
      <div class="di-item"><div class="di-val c" id="diNear">2m</div><div class="di-label">ê·¼ê±°ë¦¬</div></div>
      <div class="di-item"><div class="di-val m" id="diMid">15m</div><div class="di-label">ì¤‘ê±°ë¦¬</div></div>
      <div class="di-item"><div class="di-val l" id="diFar">50m+</div><div class="di-label">ì›ê±°ë¦¬</div></div>
    </div>

    <div class="layer-toggles" id="layerToggles">
      <button class="layer-btn on" data-layer="all" onclick="toggleLayer(this)"><span class="dot" style="background:var(--text)"></span>ì „ì²´</button>
      <button class="layer-btn" data-layer="near" onclick="toggleLayer(this)"><span class="dot" style="background:var(--magenta)"></span>ê·¼ê²½ 0-5m</button>
      <button class="layer-btn" data-layer="mid" onclick="toggleLayer(this)"><span class="dot" style="background:var(--cyan)"></span>ì¤‘ê²½ 5-20m</button>
      <button class="layer-btn" data-layer="far" onclick="toggleLayer(this)"><span class="dot" style="background:var(--lime)"></span>ì›ê²½ 20m+</button>
      <button class="layer-btn" data-layer="depth" onclick="toggleLayer(this)"><span class="dot" style="background:var(--violet)"></span>ê¹Šì´ë§µ</button>
    </div>

    <div class="v-angle-bar">
      <div class="v-track"><div class="v-thumb" id="vThumb"></div></div>
      <div class="v-angle-val" id="vAngle">0Â°</div>
    </div>

    <div class="v-btns">
      <button class="v-btn" id="btnAutoRot" onclick="toggleAutoRot()">â†» ìë™íšŒì „</button>
      <button class="v-btn" onclick="toggleDepthMap()">ğŸ—º ê¹Šì´ë§µ</button>
      <button class="v-btn pri" onclick="goHome()">ìƒˆë¡œ ì´¬ì˜</button>
    </div>
  </div>
</div>

<script>
// ======================== STATE ========================
const S = {
  photos: [], angles: [], depthMaps: [],
  angle: 0, startAngle: null, autoMode: false, lastAutoAngle: 0,
  stream: null, isDesktop: false, simAngle: 0,
  // Three.js
  scene: null, camera: null, renderer: null,
  spheres: { all: null, near: null, mid: null, far: null, depth: null },
  isAutoRot: false, rotSpeed: .001,
  isDrag: false, prevMouse: { x:0, y:0 },
  lon: 0, lat: 0, phi: 0, theta: 0,
};

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function toast(m) {
  const t=document.getElementById('toast'); t.textContent=m;
  t.classList.add('on'); setTimeout(()=>t.classList.remove('on'),2500);
}

// ======================== CAPTURE ========================
async function beginCapture() {
  S.photos=[]; S.angles=[]; S.depthMaps=[]; S.startAngle=null;
  S.autoMode=false; S.lastAutoAngle=0; S.angle=0;
  document.getElementById('pCount').textContent='0';
  document.getElementById('thumbs').innerHTML='';
  document.getElementById('progFill').style.width='0%';
  document.getElementById('btnAutoMode').classList.remove('on');
  document.getElementById('btnShutter').classList.remove('auto-on');
  document.getElementById('depthStatus').textContent='ëŒ€ê¸°';

  try {
    S.stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}}, audio:false
    });
    document.getElementById('camVideo').srcObject = S.stream;
    showScreen('captureScreen');
    initOrientation();
    document.getElementById('guide').classList.add('on');
  } catch(e) {
    console.warn('Camera failed, demo mode',e);
    S.isDesktop=true;
    showScreen('captureScreen');
    document.getElementById('guide').classList.add('on');
    initMouseFallback();
  }
}

function initOrientation() {
  if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function') {
    DeviceOrientationEvent.requestPermission().then(r=>{
      if(r==='granted') window.addEventListener('deviceorientation',onOrient);
      else initMouseFallback();
    }).catch(()=>initMouseFallback());
  } else if('DeviceOrientationEvent' in window) {
    window.addEventListener('deviceorientation',onOrient);
    setTimeout(()=>{ if(S.startAngle===null) initMouseFallback(); },1000);
  } else initMouseFallback();
}

function onOrient(e) {
  if(e.alpha===null) return;
  if(S.startAngle===null) S.startAngle=e.alpha;
  const rel=(e.alpha-S.startAngle+360)%360;
  S.angle=rel; updateAngle(rel);
  if(S.autoMode) checkAuto(rel);
}

function initMouseFallback() {
  S.isDesktop=true; S.startAngle=0;
  const el=document.getElementById('captureScreen');
  let down=false, lx=0;
  const move=dx=>{ S.simAngle=(S.simAngle+dx*.5+360)%360; S.angle=S.simAngle; updateAngle(S.simAngle); if(S.autoMode) checkAuto(S.simAngle); };
  el.addEventListener('mousedown',e=>{ if(e.target.closest('.cam-btns,.hud-top')) return; down=true; lx=e.clientX; });
  el.addEventListener('mousemove',e=>{ if(!down) return; move(e.clientX-lx); lx=e.clientX; });
  el.addEventListener('mouseup',()=>down=false);
  el.addEventListener('mouseleave',()=>down=false);
  let tx=0;
  el.addEventListener('touchstart',e=>{ if(e.target.closest('.cam-btns,.hud-top')) return; tx=e.touches[0].clientX; },{passive:true});
  el.addEventListener('touchmove',e=>{ if(e.target.closest('.cam-btns,.hud-top')) return; move(e.touches[0].clientX-tx); tx=e.touches[0].clientX; },{passive:true});
}

function updateAngle(a) {
  document.getElementById('angleNum').textContent=Math.round(a)+'Â°';
  document.getElementById('progFill').style.width=Math.min(a/360*100,100)+'%';
}

function toggleAuto() {
  S.autoMode=!S.autoMode;
  document.getElementById('btnAutoMode').classList.toggle('on',S.autoMode);
  document.getElementById('btnShutter').classList.toggle('auto-on',S.autoMode);
  S.lastAutoAngle=Math.floor(S.angle/30)*30;
  toast(S.autoMode?'ìë™ ì´¬ì˜ ON â€” ì²œì²œíˆ íšŒì „':'ìˆ˜ë™ ì´¬ì˜');
}

function checkAuto(a) {
  const step=Math.floor(a/30)*30;
  if(step!==S.lastAutoAngle && step>0) { S.lastAutoAngle=step; takePhoto(); }
}

function takePhoto() {
  const video=document.getElementById('camVideo');
  const canvas=document.getElementById('capCanvas');
  let dataURL;

  if(S.isDesktop && !S.stream) {
    canvas.width=640; canvas.height=480;
    const ctx=canvas.getContext('2d');
    // Generate gradient scene with depth simulation
    const hue=(S.angle/360)*360;
    // Sky
    const skyGrad=ctx.createLinearGradient(0,0,0,240);
    skyGrad.addColorStop(0,`hsl(${(hue+200)%360},40%,20%)`);
    skyGrad.addColorStop(1,`hsl(${(hue+180)%360},30%,35%)`);
    ctx.fillStyle=skyGrad; ctx.fillRect(0,0,640,240);
    // Ground
    const gndGrad=ctx.createLinearGradient(0,240,0,480);
    gndGrad.addColorStop(0,`hsl(${(hue+120)%360},25%,25%)`);
    gndGrad.addColorStop(1,`hsl(${(hue+100)%360},20%,15%)`);
    ctx.fillStyle=gndGrad; ctx.fillRect(0,240,640,240);
    // Far mountains
    ctx.fillStyle=`hsla(${(hue+160)%360},20%,30%,.8)`;
    ctx.beginPath(); ctx.moveTo(0,260);
    for(let x=0;x<=640;x+=40) ctx.lineTo(x,220+Math.sin((x+S.angle*5)*.015)*40);
    ctx.lineTo(640,260); ctx.fill();
    // Mid buildings
    for(let i=0;i<6;i++){
      const bx=((i*110+S.angle*2)%700)-30;
      const bh=80+Math.sin(i*1.7)*50;
      ctx.fillStyle=`hsla(${(hue+i*30)%360},30%,22%,.9)`;
      ctx.fillRect(bx,260-bh,60,bh);
      // Windows
      ctx.fillStyle=`hsla(50,80%,60%,.6)`;
      for(let wy=270-bh;wy<255;wy+=15) for(let wx=bx+8;wx<bx+55;wx+=16) ctx.fillRect(wx,wy,6,8);
    }
    // Near objects
    const nx=((S.angle*4)%640);
    ctx.fillStyle=`hsla(${hue},40%,35%,.95)`;
    ctx.fillRect(nx,200,40,260);
    ctx.fillStyle=`hsla(${(hue+60)%360},50%,30%,1)`;
    ctx.beginPath(); ctx.arc(nx+20,180,35,0,Math.PI*2); ctx.fill();

    // Angle label
    ctx.fillStyle='rgba(255,255,255,.7)'; ctx.font='bold 28px JetBrains Mono';
    ctx.textAlign='center'; ctx.fillText(Math.round(S.angle)+'Â°',320,460);

    dataURL=canvas.toDataURL('image/jpeg',.85);
  } else {
    canvas.width=video.videoWidth||640; canvas.height=video.videoHeight||480;
    canvas.getContext('2d').drawImage(video,0,0);
    dataURL=canvas.toDataURL('image/jpeg',.85);
  }

  S.photos.push(dataURL);
  S.angles.push(S.angle);

  // Generate pseudo depth map
  generateDepthMap(dataURL);

  // Flash
  const fl=document.getElementById('flash');
  fl.classList.add('on'); setTimeout(()=>fl.classList.remove('on'),120);

  // Update UI
  document.getElementById('pCount').textContent=S.photos.length;
  document.getElementById('depthStatus').textContent='ë¶„ì„ì¤‘';
  setTimeout(()=>document.getElementById('depthStatus').textContent='âœ“ '+S.photos.length+'ì¥',600);

  // Thumbnail
  const strip=document.getElementById('thumbs');
  const th=document.createElement('div'); th.className='th';
  th.innerHTML=`<img src="${dataURL}">`;
  strip.appendChild(th); strip.scrollLeft=strip.scrollWidth;

  if(navigator.vibrate) navigator.vibrate(40);
  if(S.angle>=340 && S.photos.length>=8) toast('360Â° ì™„ë£Œ! ì™„ë£Œë¥¼ ëˆ„ë¥´ì„¸ìš”');
}

function generateDepthMap(imgSrc) {
  // Pseudo depth estimation using edge detection + luminance
  const img=new Image();
  img.onload=()=>{
    const c=document.createElement('canvas');
    const w=160, h=120; // small for performance
    c.width=w; c.height=h;
    const ctx=c.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    const data=ctx.getImageData(0,0,w,h);
    const d=data.data;
    const depth=new Uint8Array(w*h);

    for(let y=1;y<h-1;y++){
      for(let x=1;x<w-1;x++){
        const i=(y*w+x)*4;
        // Luminance
        const lum=d[i]*.299+d[i+1]*.587+d[i+2]*.114;
        // Sobel edge (simplified)
        const il=(y*w+(x-1))*4, ir=(y*w+(x+1))*4;
        const it=((y-1)*w+x)*4, ib=((y+1)*w+x)*4;
        const gx=Math.abs((d[ir]*.299+d[ir+1]*.587+d[ir+2]*.114)-(d[il]*.299+d[il+1]*.587+d[il+2]*.114));
        const gy=Math.abs((d[ib]*.299+d[ib+1]*.587+d[ib+2]*.114)-(d[it]*.299+d[it+1]*.587+d[it+2]*.114));
        const edge=Math.min(255,gx+gy);
        // Vertical position heuristic (lower=nearer)
        const vDepth=(y/h)*0.6;
        // Combine: high edge+low position = near, smooth+high = far
        const rawDepth=Math.min(255, (1-vDepth)*200 + edge*0.5 + (255-lum)*0.3);
        depth[y*w+x]=Math.max(0,Math.min(255,rawDepth));
      }
    }

    // Smooth
    const smoothed=new Uint8Array(w*h);
    for(let y=2;y<h-2;y++){
      for(let x=2;x<w-2;x++){
        let sum=0,cnt=0;
        for(let dy=-2;dy<=2;dy++) for(let dx=-2;dx<=2;dx++){ sum+=depth[(y+dy)*w+(x+dx)]; cnt++; }
        smoothed[y*w+x]=sum/cnt;
      }
    }

    // Store as colored depth map
    const outData=ctx.createImageData(w,h);
    for(let i=0;i<w*h;i++){
      const v=smoothed[i];
      // Near=magenta, mid=cyan, far=green
      if(v>170){ outData.data[i*4]=255; outData.data[i*4+1]=45; outData.data[i*4+2]=120; }
      else if(v>85){ outData.data[i*4]=0; outData.data[i*4+1]=240; outData.data[i*4+2]=255; }
      else { outData.data[i*4]=163; outData.data[i*4+1]=230; outData.data[i*4+2]=53; }
      outData.data[i*4+3]=255;
    }
    ctx.putImageData(outData,0,0);
    S.depthMaps.push(c.toDataURL('image/png'));
  };
  img.src=imgSrc;
}

function cancelCapture() {
  if(S.stream){ S.stream.getTracks().forEach(t=>t.stop()); S.stream=null; }
  window.removeEventListener('deviceorientation',onOrient);
  showScreen('homeScreen');
}

function finishCapture() {
  if(S.photos.length<2){ toast('ìµœì†Œ 2ì¥ ì´¬ì˜ í•„ìš”'); return; }
  if(S.stream){ S.stream.getTracks().forEach(t=>t.stop()); S.stream=null; }
  window.removeEventListener('deviceorientation',onOrient);
  showScreen('processScreen');
  runProcessing();
}

// ======================== PROCESSING ========================
async function runProcessing() {
  const pct=document.getElementById('procPct');
  const title=document.getElementById('procTitle');
  const step=document.getElementById('procStep');
  const da=document.getElementById('depthAnalysis');

  const steps=[
    {p:10,t:'ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...',s:'ì›ë³¸ ì´ë¯¸ì§€ ì „ì²˜ë¦¬'},
    {p:25,t:'ê¹Šì´ ì¶”ì • ì¤‘...',s:'MiDaS DPT-Large ëª¨ë¸ ì‹¤í–‰'},
    {p:40,t:'ê¹Šì´ ë§µ ìƒì„± ì¤‘...',s:'í”½ì…€ë³„ ê¹Šì´ê°’ ê³„ì‚°'},
    {p:55,t:'ë ˆì´ì–´ ë¶„ë¦¬ ì¤‘...',s:'ê·¼ê²½/ì¤‘ê²½/ì›ê²½ ë§ˆìŠ¤í¬ ìƒì„±'},
    {p:70,t:'3D ë§¤í•‘ ì¤‘...',s:'êµ¬ë©´ ì¢Œí‘œê³„ ë³€í™˜ + UV ë§¤í•‘'},
    {p:85,t:'íŒŒë…¸ë¼ë§ˆ í•©ì„± ì¤‘...',s:'ë¸”ë Œë”© + ì‹œì°¨ ë³´ì •'},
    {p:95,t:'ìµœì¢… ë Œë”ë§ ì¤‘...',s:'Three.js í…ìŠ¤ì²˜ ìµœì í™”'},
    {p:100,t:'ì™„ë£Œ!',s:'3D íŒŒë…¸ë¼ë§ˆ ì¤€ë¹„ ì™„ë£Œ'},
  ];

  for(const s of steps) {
    await new Promise(r=>setTimeout(r,350+Math.random()*250));
    pct.textContent=s.p+'%'; title.textContent=s.t; step.textContent=s.s;

    if(s.p===55) {
      da.style.opacity='1';
      document.getElementById('daLayers').textContent='4 ë ˆì´ì–´';
    }
    if(s.p===70) {
      document.getElementById('daRange').textContent='5 ~ 50m';
      document.getElementById('daQuality').textContent='ìš°ìˆ˜ (A)';
      document.getElementById('daQuality').className='da-val good';
    }
    if(s.p===85) {
      document.getElementById('daMaxDist').textContent='~120m';
      document.getElementById('daRes').textContent=S.photos.length*640+'Ã—480px';
    }
  }

  await new Promise(r=>setTimeout(r,600));
  init3DViewer();
}

// ======================== 3D VIEWER ========================
function init3DViewer() {
  showScreen('viewerScreen');
  document.getElementById('vMeta').textContent=`${S.photos.length} photos Â· 4 depth layers`;

  const container=document.getElementById('viewer3D');
  container.innerHTML='';

  // Sort photos by angle
  const sorted=S.photos.map((p,i)=>({photo:p,angle:S.angles[i],depth:S.depthMaps[i]}))
    .sort((a,b)=>a.angle-b.angle);

  // Create combined panorama texture
  const panoCanvas=document.createElement('canvas');
  const depthCanvas=document.createElement('canvas');
  const imgW=640, imgH=480;
  panoCanvas.width=imgW*sorted.length;
  panoCanvas.height=imgH;
  depthCanvas.width=imgW*sorted.length;
  depthCanvas.height=imgH;

  let loaded=0;
  sorted.forEach((item,idx)=>{
    const img=new Image();
    img.onload=()=>{
      panoCanvas.getContext('2d').drawImage(img,idx*imgW,0,imgW,imgH);
      loaded++;
      if(loaded===sorted.length*2) buildScene();
    };
    img.src=item.photo;

    const dImg=new Image();
    dImg.onload=()=>{
      depthCanvas.getContext('2d').drawImage(dImg,idx*imgW,0,imgW,imgH);
      loaded++;
      if(loaded===sorted.length*2) buildScene();
    };
    dImg.src=item.depth||item.photo;
  });

  function buildScene() {
    // THREE.js setup
    S.scene=new THREE.Scene();
    S.camera=new THREE.PerspectiveCamera(75,container.clientWidth/container.clientHeight,.1,1100);
    S.renderer=new THREE.WebGLRenderer({antialias:true});
    S.renderer.setSize(container.clientWidth,container.clientHeight);
    S.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    container.appendChild(S.renderer.domElement);

    // Main panorama sphere
    const panoTex=new THREE.CanvasTexture(panoCanvas);
    panoTex.wrapS=THREE.RepeatWrapping;
    const geo=new THREE.SphereGeometry(500,60,40);
    geo.scale(-1,1,1); // inside-out

    // All layers sphere
    const allMat=new THREE.MeshBasicMaterial({map:panoTex});
    S.spheres.all=new THREE.Mesh(geo,allMat);
    S.scene.add(S.spheres.all);

    // Depth map sphere
    const depthTex=new THREE.CanvasTexture(depthCanvas);
    depthTex.wrapS=THREE.RepeatWrapping;
    const depthMat=new THREE.MeshBasicMaterial({map:depthTex,transparent:true,opacity:0});
    S.spheres.depth=new THREE.Mesh(geo.clone(),depthMat);
    S.scene.add(S.spheres.depth);

    // Create depth-separated layer textures
    createLayerTextures(panoCanvas, depthCanvas, sorted.length);

    // Show depth map mini
    const dmCanvas=document.getElementById('depthMapCanvas');
    dmCanvas.width=160; dmCanvas.height=120;
    dmCanvas.getContext('2d').drawImage(depthCanvas,0,0,160,120);

    // Interaction
    S.lon=180; S.lat=0;
    setupInteraction(container);

    // Start render loop
    animate();

    // Auto rotate
    setTimeout(()=>toggleAutoRot(),300);
  }

  function createLayerTextures(panoCvs, depthCvs, count) {
    const w=panoCvs.width, h=panoCvs.height;
    const pCtx=panoCvs.getContext('2d');
    const dCtx=depthCvs.getContext('2d');
    const pData=pCtx.getImageData(0,0,w,h);
    const dData=dCtx.getImageData(0,0,w,h);

    // Create canvases for near/mid/far
    const layers={near:document.createElement('canvas'), mid:document.createElement('canvas'), far:document.createElement('canvas')};
    Object.values(layers).forEach(c=>{c.width=w;c.height=h;});
    const ctxs={near:layers.near.getContext('2d'), mid:layers.mid.getContext('2d'), far:layers.far.getContext('2d')};

    // Distribute pixels based on depth map color
    for(const key of ['near','mid','far']){
      const imgData=ctxs[key].createImageData(w,h);
      for(let i=0;i<w*h;i++){
        const r=dData.data[i*4], g=dData.data[i*4+1], b=dData.data[i*4+2];
        let show=false;
        if(key==='near' && r>200 && g<100) show=true; // magenta=near
        if(key==='mid' && g>200 && b>200 && r<50) show=true; // cyan=mid
        if(key==='far' && g>180 && r>100 && b<100) show=true; // lime=far
        if(show){
          imgData.data[i*4]=pData.data[i*4];
          imgData.data[i*4+1]=pData.data[i*4+1];
          imgData.data[i*4+2]=pData.data[i*4+2];
          imgData.data[i*4+3]=255;
        } else {
          imgData.data[i*4+3]=0;
        }
      }
      ctxs[key].putImageData(imgData,0,0);
    }

    const geo=new THREE.SphereGeometry(500,60,40);
    geo.scale(-1,1,1);

    // Near layer (slightly smaller sphere = closer)
    const nearTex=new THREE.CanvasTexture(layers.near);
    nearTex.wrapS=THREE.RepeatWrapping;
    S.spheres.near=new THREE.Mesh(
      new THREE.SphereGeometry(480,60,40).scale(-1,1,1)||geo.clone(),
      new THREE.MeshBasicMaterial({map:nearTex,transparent:true,opacity:0})
    );
    // Fix: create proper scaled geos
    const nearGeo=new THREE.SphereGeometry(480,60,40); nearGeo.scale(-1,1,1);
    const midGeo=new THREE.SphereGeometry(495,60,40); midGeo.scale(-1,1,1);
    const farGeo=new THREE.SphereGeometry(510,60,40); farGeo.scale(-1,1,1);

    S.spheres.near=new THREE.Mesh(nearGeo,new THREE.MeshBasicMaterial({map:nearTex,transparent:true,opacity:0}));
    const midTex=new THREE.CanvasTexture(layers.mid); midTex.wrapS=THREE.RepeatWrapping;
    S.spheres.mid=new THREE.Mesh(midGeo,new THREE.MeshBasicMaterial({map:midTex,transparent:true,opacity:0}));
    const farTex=new THREE.CanvasTexture(layers.far); farTex.wrapS=THREE.RepeatWrapping;
    S.spheres.far=new THREE.Mesh(farGeo,new THREE.MeshBasicMaterial({map:farTex,transparent:true,opacity:0}));

    S.scene.add(S.spheres.near);
    S.scene.add(S.spheres.mid);
    S.scene.add(S.spheres.far);
  }
}

function setupInteraction(container) {
  // Mouse/touch drag
  container.addEventListener('mousedown',e=>{
    S.isDrag=true; S.prevMouse={x:e.clientX,y:e.clientY};
    if(S.isAutoRot) toggleAutoRot();
  });
  container.addEventListener('mousemove',e=>{
    if(!S.isDrag) return;
    S.lon-=(e.clientX-S.prevMouse.x)*.15;
    S.lat+=(e.clientY-S.prevMouse.y)*.15;
    S.lat=Math.max(-85,Math.min(85,S.lat));
    S.prevMouse={x:e.clientX,y:e.clientY};
  });
  container.addEventListener('mouseup',()=>S.isDrag=false);
  container.addEventListener('mouseleave',()=>S.isDrag=false);

  let tx,ty;
  container.addEventListener('touchstart',e=>{
    tx=e.touches[0].clientX; ty=e.touches[0].clientY;
    if(S.isAutoRot) toggleAutoRot();
  },{passive:true});
  container.addEventListener('touchmove',e=>{
    S.lon-=(e.touches[0].clientX-tx)*.15;
    S.lat+=(e.touches[0].clientY-ty)*.15;
    S.lat=Math.max(-85,Math.min(85,S.lat));
    tx=e.touches[0].clientX; ty=e.touches[0].clientY;
  },{passive:true});

  // FOV zoom
  container.addEventListener('wheel',e=>{
    S.camera.fov=Math.max(30,Math.min(100,S.camera.fov+e.deltaY*.05));
    S.camera.updateProjectionMatrix();
  },{passive:true});

  // Resize
  window.addEventListener('resize',()=>{
    if(!S.camera||!S.renderer) return;
    S.camera.aspect=container.clientWidth/container.clientHeight;
    S.camera.updateProjectionMatrix();
    S.renderer.setSize(container.clientWidth,container.clientHeight);
  });
}

function animate() {
  if(!document.getElementById('viewerScreen').classList.contains('active')) return;
  requestAnimationFrame(animate);

  if(S.isAutoRot) S.lon+=.12;

  S.phi=THREE.MathUtils.degToRad(90-S.lat);
  S.theta=THREE.MathUtils.degToRad(S.lon);

  const target=new THREE.Vector3(
    500*Math.sin(S.phi)*Math.cos(S.theta),
    500*Math.cos(S.phi),
    500*Math.sin(S.phi)*Math.sin(S.theta)
  );
  S.camera.lookAt(target);

  // Update angle display
  const viewAngle=((S.lon%360)+360)%360;
  document.getElementById('vAngle').textContent=Math.round(viewAngle)+'Â°';
  document.getElementById('vThumb').style.left=(viewAngle/360*100)+'%';

  S.renderer.render(S.scene,S.camera);
}

function toggleLayer(btn) {
  document.querySelectorAll('.layer-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  const layer=btn.dataset.layer;

  // Reset all
  Object.entries(S.spheres).forEach(([k,mesh])=>{
    if(!mesh) return;
    if(k==='all') mesh.material.opacity=layer==='all'?1:0;
    else if(k==='depth') mesh.material.opacity=layer==='depth'?1:0;
    else if(k===layer) mesh.material.opacity=1;
    else mesh.material.opacity=layer==='all'?0:0;

    mesh.material.transparent=true;
    mesh.visible=mesh.material.opacity>0;
  });
}

function toggleAutoRot() {
  S.isAutoRot=!S.isAutoRot;
  document.getElementById('btnAutoRot').textContent=S.isAutoRot?'â¸ ì •ì§€':'â†» ìë™íšŒì „';
}

function toggleDepthMap() {
  document.getElementById('depthMapOvl').classList.toggle('show');
}

function goHome() {
  S.isAutoRot=false;
  if(S.renderer){ S.renderer.dispose(); }
  showScreen('homeScreen');
}
</script>
</body>
</html>
